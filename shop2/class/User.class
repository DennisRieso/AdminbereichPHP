<?php

class User
{
	
	public $id; 	
	public  $username; 	
	public  $password; 	
	public  $typ; 
	private $deleted;

	public function __construct( $in_id = 0 )
	{		
		if( $in_id > 0 )
		{   
			## User mit id aus DB laden	
			$sql = "SELECT * FROM `user` WHERE `id` = ". intval( $in_id ) ." AND deleted = 0 ;";
			$res = mysqli_query( DB::$connection , $sql );
			
			// ist GENAU 1 datensatz im ResultSet
			if( mysqli_num_rows( $res ) == 1 )
			{
				$row = mysqli_fetch_assoc( $res );
			
				$this->id 			= $row['id']; 
				$this->username     = $row['username']; 
				$this->password     = $row['password'];  
				$this->typ     		= $row['typ'];				
				$this->deleted      = $row['deleted']; 	
			}
			// wenn KEIN Datensatzt da ist 
			else if( mysqli_num_rows( $res ) == 0 )
			{
				die( " FEHLER : Keinen Datensatzt trotz ID gefunden !! ( vielleicht gelÃ¶scht ?? ) ");
			}
			else
			{
				die( " PANIC : Mehr als 1 Datensatzt gefunden !!  ");
			}
			
		}		
		else
		{
			## neuer Artikel
			$this->id      = 0;
			$this->deleted = 0;
		}
	}


	private function create()
	{
		if( $this->id > 0 )
		{
			echo " Fehler: Create mit ID > 0 versucht !!! ";
			return;
		}
		
		$sql_username = mysqli_real_escape_string( DB::$connection , $this->username );   
		$sql_password = $this->password;   
		$sql_typ 	  = intval($this->typ);  

		$sql = "INSERT INTO `user` 
				( `username`           , `password` , 				`typ`           ) 
				VALUES 
				( '". $sql_username ."', '". $sql_password ."','". $sql_typ ."');";
					
		$res = mysqli_query( DB::$connection , $sql );
		
		if( $res === true )
		{
			$this->id = mysqli_insert_id( DB::$connection );
		}
		else
		{
			echo " Insert ist fehlgeschalgen : ". mysqli_error( DB::$connection );
		}		
	}
	
	private function update()
	{
		if( $this->id < 1 )
		{
			echo " Fehler: Update mit ID = 0 versucht !!! ";
			return;
		}
		
		$sql_username = mysqli_real_escape_string( DB::$connection , $this->username );   
		$sql_password = mysqli_real_escape_string( DB::$connection , $this->password );   
		$sql_typ 	  = intval($this->typ ); 
		
		$sql = "UPDATE `user` 
					SET 
						`username`     = '". $sql_username ."', 
						`password`     = '". $sql_password ."',
						`typ`     	   = '". $sql_typ ."', 						
						`deleted`      = '". $this->deleted ."' 
					
					WHERE `id` = ". intval( $this->id ) ." ;";
		
		
		$res = mysqli_query( DB::$connection , $sql );	

		if( $res === false )
		{
			echo " Update ist fehlgeschalgen : ". mysqli_error( DB::$connection );
		}			
	}

	public function save()
	{
		if( $this->id > 0 )
		{
			$this->update();
		}
		else
		{
			$this->create();
		}
	}

	public function del_it()
	{
		if( $this->id < 1 )
		{
			echo " Fehler: Delete mit ID = 0 versucht !!! ";
			return;
		}			
		
		$this->deleted = 1;

		$this->update();
	}
	
	public static function login( $in_username, $in_password )
	{
		$sql_username = mysqli_real_escape_string( DB::$connection , $in_username );   
		$sql_password = md5($in_password); 
		
		$sql = "SELECT * FROM `user` 
				WHERE `username` 	= '". $sql_username ."' AND 
					  `password` 	= '". $sql_password ."' AND
					  `deleted` 	= 0; ";
					  
		$res = mysqli_query( DB::$connection , $sql );	

		if( mysqli_num_rows($res) == 1 )
		{
			$row = mysqli_fetch_assoc($res);
			return $row['id'];
		}	
		else
		{
			return 0;
		}
		
	}

	public static function getAll()
	{
		$sql = "SELECT `id` FROM `user` WHERE `deleted` = 0; ";  
		$res = mysqli_query( DB::$connection , $sql );
		
		$re_array = array();
		
		while( $row = mysqli_fetch_assoc($res) )
		{
			$re_array[] = $row["id"];
		}
		return $re_array;
	}
	
	
	public static function getAllWithName()
	{
		$sql = "SELECT `id` , `username` FROM `user` WHERE `deleted` = 0; ";  
		$res = mysqli_query( DB::$connection , $sql );
		
		$re_array = array();
		
		while( $row = mysqli_fetch_assoc($res) )
		{
			$re_array[$row['id']] = $row['username'];
		}
		return $re_array;
	}

}
